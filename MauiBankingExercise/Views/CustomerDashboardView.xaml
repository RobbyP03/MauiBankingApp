<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiBankingExercise.Views.CustomerDashboardView"
             xmlns:viewmodels="clr-namespace:MauiBankingExercise.ViewModels"
             xmlns:views="clr-namespace:MauiBankingExercise.Views"
             xmlns:models="clr-namespace:MauiBankingExercise.Models"
             Title="{Binding Customer.FirstName}" x:DataType="viewmodels:CustomerDashboardViewModel">

    <ScrollView>
        <StackLayout Padding="20">

            <!-- Customer Name Header -->
            <Label Text="{Binding Customer.FirstName, StringFormat='Welcome, {0}'}"
                   FontAttributes="Bold" 
                   Margin="0,0,0,10"
                   FontSize="24"
                   HorizontalOptions="Center" />

            <Label Text="{Binding Customer.LastName}"
                   FontAttributes="Bold"
                   Margin="0,0,0,20"
                   FontSize="20"
                   HorizontalOptions="Center" />

            <!-- Customer Accounts List -->
            <CollectionView ItemsSource="{Binding CustomerAccounts}" 
                            SelectionMode="Single" 
                            SelectedItem="{Binding SelectedAccount}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Account">
                        <Border Margin="5" 
                                Padding="15" 
                                BackgroundColor="LightBlue" 
                                Stroke="Gray" 
                                StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,Auto,Auto" 
                                  ColumnDefinitions="*,Auto">

                                <!-- Account Number -->
                                <Label Text="{Binding AccountNumber, StringFormat='Account: {0}'}" 
                                       FontSize="16"
                                       FontAttributes="Bold" 
                                       Grid.Row="0" 
                                       Grid.Column="0"/>

                                <!-- Account Balance  -->
                                <Label Text="{Binding AccountBalance, StringFormat='R{0:N2}'}" 
                                       FontSize="20"
                                       FontAttributes="Bold" 
                                       TextColor="Green"
                                       Grid.Row="0" 
                                       Grid.Column="1"/>

                                <!-- Date Opened -->
                                <Label Text="{Binding DateOpened, StringFormat='Opened: {0:MMM dd, yyyy}'}" 
                                       FontSize="12"
                                       TextColor="Gray"
                                       Grid.Row="2" 
                                       Grid.ColumnSpan="2"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Instruction Text -->
            <Label Text="Tap on an account above to make new transactions"
                   FontSize="14"
                   TextColor="Gray"
                   HorizontalOptions="Center"
                   Margin="10,10,10,20"/>

            <!-- Recent Transactions Section -->
            <Label Text="Recent Transactions" 
                   FontSize="18" 
                   FontAttributes="Bold" 
                   Margin="10,20,10,10"/>

            <!-- Add debug label to see transaction count -->
            <Label Text="{Binding RecentTransactions.Count, StringFormat='Transactions found: {0}'}" 
                   FontSize="14" 
                   TextColor="Red" 
                   Margin="10,0"/>

            <Button Text="{Binding TransactionsDisplayText}" 
                    Command="{Binding ToggleTransactionsCommand}"
                    BackgroundColor="LightBlue"
                    Margin="10,0"/>

            <Button Text="Refresh" 
                    Command="{Binding RefreshCommand}"
                    BackgroundColor="Green"
                    TextColor="White"
                    Margin="10,5"/>

            <CollectionView ItemsSource="{Binding RecentTransactions}"
                            BackgroundColor="White">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Transaction">
                        <Border Margin="5" 
                                Padding="10" 
                                BackgroundColor="White" 
                                Stroke="LightGray" 
                                StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="5"/>
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,Auto,Auto" 
                                  ColumnDefinitions="*,Auto">

                                <!-- Transaction Description -->
                                <Label Text="{Binding Description}" 
                                       FontAttributes="Bold"
                                       Grid.Row="0" 
                                       Grid.Column="0"/>

                                <!-- Transaction Amount - FIXED: Added the amount display -->
                                <Label Text="{Binding Amount, StringFormat='R{0:N2}'}" 
                                       FontAttributes="Bold"
                                       Grid.Row="0" 
                                       Grid.Column="1"
                                       TextColor="{Binding Amount, Converter={StaticResource AmountToColorConverter}}"
                                       HorizontalOptions="End"/>

                                <!-- Transaction Date -->
                                <Label Text="{Binding TransactionDate, StringFormat='{0:MMM dd, yyyy HH:mm}'}" 
                                       FontSize="12" 
                                       TextColor="Gray"
                                       Grid.Row="1" 
                                       Grid.Column="0"/>

                                <!-- Account Number - FIXED:  -->
                                <Label Text="{Binding Account.AccountNumber, StringFormat='Account: {0}'}" 
                                       FontSize="12" 
                                       TextColor="Gray"
                                       Grid.Row="2" 
                                       Grid.ColumnSpan="2"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>
    </ScrollView>
</views:BasePage>